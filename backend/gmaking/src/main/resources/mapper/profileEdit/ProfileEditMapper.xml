<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.gmaking.profileEdit.dao.ProfileEditDAO">
    <!-- 닉네임/이미지 조회 -->
    <select id="selectProfile">
        SELECT u.USER_NICKNAME AS nickname,
                COALESCE(i.IMAGE_URL, '') AS profileImageUrl
            FROM tb_user u
            LEFT JOIN tb_image i ON i.IMAGE_ID = u.IMAGE_ID
        WHERE u.USER_ID = #{userId}
    </select>

    <!--  닉네임 업데이트  -->
    <update id="updateNickname">
        UPDATE tb_user
            SET USER_NICKNAME = #{nickname}
        WHERE USER_ID = #{userId}
    </update>

    <!--  비밀번호 해시 조회  -->
    <select id="selectPasswordHash" resultType="string">
        SELECT USER_PASSWORD FROM tb_user WHERE USER_ID = #{userId}
    </select>

    <!--  비밀번호 변경  -->
    <update id="updatePasswordHash">
        UPDATE USER_PASSWORD FROM tb_user WHERE USER_ID = #{userId}
    </update>

    <!-- 이미지 저장 -->
    <insert id="insertImage" parameterType="map" useGeneratedKeys="true" keyProperty="p.imageId">
        INSERT INTO tb_image
            (IMAGE_ORIGINAL_NAME, IMAGE_URL, IMAGE_NAME, IMAGE_TYPE,
            CREATED_DATE, CREATED_BY, UPDATED_DATE, UPDATED_BY)
        VALUES
            (#{p.imageOriginalName}, #{p.imageUrl}, #{p.imageName}, #{p.imageType},
            NOW(), #{p.createdBy}, NOW(), #{p.updatedBy})
    </insert>

    <update id="updateUserImage">
        UPDATE tb_user SET IMAGE_ID = #{imageId} WHERE USER_ID = #{userId}
    </update>

</mapper>