<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.gmaking.admin.dao.AdminDAO">

    <resultMap id="LoginVOResultMap" type="com.project.gmaking.login.vo.LoginVO">
        <id property="userId" column="USER_ID"/>
        <result property="userName" column="USER_NAME"/>
        <result property="userEmail" column="USER_EMAIL"/>
        <result property="userNickname" column="USER_NICKNAME"/>
        <result property="role" column="ROLE"/>
        <result property="createdDate" column="CREATED_DATE"/>

        <result property="characterName" column="REPR_CHARACTER_NAME"/>
        <result property="characterCount" column="CHARACTER_COUNT"/>
        <result property="incubatorCount" column="INCUBATOR_COUNT"/>
    </resultMap>

    <resultMap id="CharacterVOResultMap" type="com.project.gmaking.admin.vo.CharacterVO">
        <id property="characterId" column="CHARACTER_ID"/>
        <result property="userId" column="USER_ID"/>
        <result property="characterName" column="CHARACTER_NAME"/>
        <result property="gradeId" column="GRADE_ID"/>
        <result property="totalStageClears" column="TOTAL_STAGE_CLEARS"/>
        <result property="evolutionStep" column="EVOLUTION_STEP"/>
        <result property="createdDate" column="CREATED_DATE"/>

        <result property="imageUrl" column="IMAGE_URL"/>
        <result property="userNickname" column="USER_NICKNAME"/>
    </resultMap>

    <resultMap id="PurchaseVOResultMap" type="com.project.gmaking.admin.vo.PurchaseVO">
        <id property="purchaseId" column="PURCHASE_ID"/>
        <result property="userId" column="USER_ID"/>
        <result property="productId" column="PRODUCT_ID"/>
        <result property="quantity" column="QUANTITY"/>
        <result property="amountPaid" column="AMOUNT_PAID"/>
        <result property="method" column="METHOD"/>
        <result property="merchantUid" column="MERCHANT_UID"/>
        <result property="status" column="STATUS"/>
        <result property="productNameSnap" column="PRODUCT_NAME_SNAP"/>
        <result property="totalPriceSnap" column="TOTAL_PRICE_SNAP"/>
        <result property="approvedAt" column="APPROVED_AT"/>
        <result property="createdDate" column="CREATED_DATE"/>

        <result property="userNickname" column="USER_NICKNAME"/>
    </resultMap>

    <resultMap id="InventoryVOResultMap" type="com.project.gmaking.admin.vo.InventoryVO">
        <id property="inventoryId" column="INVENTORY_ID"/>
        <result property="userId" column="USER_ID"/>
        <result property="productId" column="PRODUCT_ID"/>
        <result property="quantity" column="QUANTITY"/>
        <result property="expiryDate" column="EXPIRY_DATE"/>
        <result property="acquiredDate" column="ACQUIRED_DATE"/>

        <result property="userNickname" column="USER_NICKNAME"/>
    </resultMap>

    <resultMap id="ProductVOResultMap" type="com.project.gmaking.admin.vo.ProductVO">
        <id property="productId" column="PRODUCT_ID"/>
        <result property="productName" column="PRODUCT_NAME"/>
        <result property="productType" column="PRODUCT_TYPE"/>
        <result property="price" column="PRICE"/>
        <result property="currencyType" column="CURRENCY_TYPE"/>
        <result property="isSale" column="IS_SALE"/>
        <result property="durationDays" column="DURATION_DAYS"/>
        <result property="packSize" column="PACK_SIZE"/>
        <result property="grantProductId" column="GRANT_PRODUCT_ID"/>
        <result property="salePrice" column="SALE_PRICE"/>
        <result property="createdDate" column="CREATED_DATE"/>
        <result property="createdBy" column="CREATED_BY"/>
        <result property="updatedDate" column="UPDATED_DATE"/>
        <result property="updatedBy" column="UPDATED_BY"/>
    </resultMap>


    <sql id="userWhereClause">
        <where>
            <if test="searchKeyword != null and searchKeyword != ''">
                AND (t1.USER_NICKNAME LIKE CONCAT('%', #{searchKeyword}, '%')
                OR t1.USER_EMAIL LIKE CONCAT('%', #{searchKeyword}, '%'))
            </if>
            <if test="filterRole != null and filterRole != ''">
                AND t1.ROLE = #{filterRole}
            </if>
        </where>
    </sql>

    <select id="countAllUsers" resultType="int">
        SELECT
            COUNT(t1.USER_ID)
        FROM
            tb_user t1
            <include refid="userWhereClause"/>
    </select>

    <select id="selectAllUsers" resultMap="LoginVOResultMap">
        SELECT
            t1.USER_ID, t1.USER_NAME, t1.USER_EMAIL, t1.USER_NICKNAME, t1.ROLE, t1.CREATED_DATE,
            t3.CHARACTER_NAME AS REPR_CHARACTER_NAME,
            COALESCE(t4.CHAR_COUNT, 0) AS CHARACTER_COUNT,
            COALESCE(t5.INCUBATOR_COUNT, 0) AS INCUBATOR_COUNT
        FROM
            tb_user t1
        LEFT JOIN
            tb_character t3 ON t1.CHARACTER_ID = t3.CHARACTER_ID
        LEFT JOIN (
            SELECT USER_ID, COUNT(*) AS CHAR_COUNT FROM tb_character GROUP BY USER_ID
            ) t4 ON t1.USER_ID = t4.USER_ID
        LEFT JOIN (
            SELECT USER_ID, SUM(QUANTITY) AS INCUBATOR_COUNT
            FROM tb_user_inventory
            WHERE PRODUCT_ID = 999
            GROUP BY USER_ID
        ) t5 ON t1.USER_ID = t5.USER_ID
        <include refid="userWhereClause"/>
        ORDER BY
        t1.CREATED_DATE DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>


    <sql id="characterWhereClause">
        <where>
            <if test="searchKeyword != null and searchKeyword != ''">
                AND (t1.CHARACTER_NAME LIKE CONCAT('%', #{searchKeyword}, '%')
                OR t3.USER_NICKNAME LIKE CONCAT('%', #{searchKeyword}, '%'))
            </if>
            <if test="filterGradeId != null">
                AND t1.GRADE_ID = #{filterGradeId}
            </if>
        </where>
    </sql>

    <select id="countAllCharacters" resultType="int">
        SELECT
            COUNT(t1.CHARACTER_ID)
        FROM
            tb_character t1
        LEFT JOIN tb_user t3 ON t1.USER_ID = t3.USER_ID
        <include refid="characterWhereClause"/>
    </select>

    <select id="selectAllCharacters" resultMap="CharacterVOResultMap">
        SELECT
            t1.CHARACTER_ID, t1.USER_ID, t1.CHARACTER_NAME, t1.GRADE_ID, t1.TOTAL_STAGE_CLEARS,
            t1.EVOLUTION_STEP, t1.CREATED_DATE, t2.IMAGE_URL, t3.USER_NICKNAME
        FROM
            tb_character t1
            LEFT JOIN tb_image t2 ON t1.IMAGE_ID = t2.IMAGE_ID
            LEFT JOIN tb_user t3 ON t1.USER_ID = t3.USER_ID
            <include refid="characterWhereClause"/>
        ORDER BY
        t1.CREATED_DATE DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>


    <sql id="purchaseWhereClause">
        <where>
            <if test="searchKeyword != null and searchKeyword != ''">
                AND (t2.USER_NICKNAME LIKE CONCAT('%', #{searchKeyword}, '%')
                OR t1.PRODUCT_NAME_SNAP LIKE CONCAT('%', #{searchKeyword}, '%'))
            </if>
            <if test="filterStatus != null and filterStatus != ''">
                AND t1.STATUS = #{filterStatus}
            </if>
        </where>
    </sql>

    <select id="countAllPurchases" resultType="int">
        SELECT
            COUNT(t1.PURCHASE_ID)
        FROM
            tb_purchase t1
        JOIN
            tb_user t2 ON t1.USER_ID = t2.USER_ID
            <include refid="purchaseWhereClause"/>
    </select>

    <select id="selectAllPurchases" resultMap="PurchaseVOResultMap">
        SELECT
            t1.PURCHASE_ID, t1.USER_ID, t1.PRODUCT_ID, t1.QUANTITY, t1.AMOUNT_PAID, t1.METHOD,
            t1.MERCHANT_UID, t1.STATUS, t1.PRODUCT_NAME_SNAP, t1.TOTAL_PRICE_SNAP,
            t1.APPROVED_AT, t1.CREATED_DATE, t2.USER_NICKNAME
        FROM
            tb_purchase t1
        JOIN
            tb_user t2 ON t1.USER_ID = t2.USER_ID
            <include refid="purchaseWhereClause"/>
        ORDER BY
        t1.CREATED_DATE DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>


    <sql id="inventoryWhereClause">
        <where>
            <if test="searchKeyword != null and searchKeyword != ''">
                AND t2.USER_NICKNAME LIKE CONCAT('%', #{searchKeyword}, '%')
            </if>
            <if test="filterProductId != null">
                AND t1.PRODUCT_ID = #{filterProductId}
            </if>
        </where>
    </sql>

    <select id="countAllInventory" resultType="int">
        SELECT
            COUNT(t1.INVENTORY_ID)
        FROM
            tb_user_inventory t1
        JOIN
            tb_user t2 ON t1.USER_ID = t2.USER_ID
            <include refid="inventoryWhereClause"/>
    </select>

    <select id="selectAllInventory" resultMap="InventoryVOResultMap">
        SELECT
            t1.INVENTORY_ID, t1.USER_ID, t1.PRODUCT_ID, t1.QUANTITY, t1.EXPIRY_DATE,
            t1.ACQUIRED_DATE, t2.USER_NICKNAME
        FROM
            tb_user_inventory t1
        JOIN
            tb_user t2 ON t1.USER_ID = t2.USER_ID
            <include refid="inventoryWhereClause"/>
        ORDER BY
        t1.ACQUIRED_DATE DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>


    <sql id="productWhereClause">
        <where>
            <if test="searchKeyword != null and searchKeyword != ''">
                AND t1.PRODUCT_NAME LIKE CONCAT('%', #{searchKeyword}, '%')
            </if>
            <if test="filterIsSale != null and filterIsSale != ''">
                AND t1.IS_SALE = #{filterIsSale}
            </if>
        </where>
    </sql>

    <select id="countAllProducts" resultType="int">
        SELECT
            COUNT(PRODUCT_ID)
        FROM
            tb_product t1
            <include refid="productWhereClause"/>
    </select>

    <select id="selectAllProducts" resultMap="ProductVOResultMap">
        SELECT
            PRODUCT_ID, PRODUCT_NAME, PRODUCT_TYPE, PRICE, CURRENCY_TYPE, IS_SALE,
            DURATION_DAYS, PACK_SIZE, GRANT_PRODUCT_ID, SALE_PRICE,
            CREATED_DATE, CREATED_BY, UPDATED_DATE, UPDATED_BY
        FROM
            tb_product t1
            <include refid="productWhereClause"/>
        ORDER BY
        t1.PRODUCT_ID DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

</mapper>