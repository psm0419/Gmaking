<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.gmaking.chat.dao.PersonaDAO">

    <!-- 캐릭터 ID로 가장 최근 페르소나 조회 -->
    <select id="selectPersonaByCharacterId" resultType="com.project.gmaking.chat.vo.PersonaVO">
        SELECT
            PERSONA_ID         AS personaId,
            CHARACTER_ID       AS characterId,
            INSTRUCTION_PROMPT AS instructionPrompt,
            CREATED_DATE       AS createdDate,
            CREATED_BY         AS createdBy,
            UPDATED_DATE       AS updatedDate,
            UPDATED_BY         AS updatedBy
        FROM TB_PERSONA
        WHERE CHARACTER_ID = #{characterId}
        ORDER BY UPDATED_DATE DESC, PERSONA_ID DESC
        LIMIT 1
    </select>

    <!-- 새 페르소나 생성 -->
    <insert id="insertPersona">
        INSERT INTO TB_PERSONA (
            CHARACTER_ID,
            INSTRUCTION_PROMPT,
            CREATED_DATE,
            CREATED_BY,
            UPDATED_DATE,
            UPDATED_BY
        ) VALUES (
            #{characterId},
            #{instructionPrompt},
            NOW(),
            #{actor},
            NOW(),
            #{actor}
        )
    </insert>

</mapper>
