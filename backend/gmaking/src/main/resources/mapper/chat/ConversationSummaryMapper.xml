<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.gmaking.chat.dao.ConversationSummaryDAO">

    <resultMap id="ConversationSummaryMap" type="com.project.gmaking.chat.vo.ConversationSummaryVO">
        <id     column="CONVERSATION_ID" property="conversationId"/>
        <result column="ROLLING_SUMMARY" property="rollingSummary"/>
        <result column="SUMMARY_VERSION" property="summaryVersion"/>
        <result column="LAST_TURN_ID"    property="lastTurnId"/>
        <result column="LENGTH_CHARS"    property="lengthChars"/>
        <result column="UPDATED_BY"      property="updatedBy"/>
        <result column="UPDATED_DATE"    property="updatedDate"/>
    </resultMap>


    <insert id="upsertRollingSummary" parameterType="com.project.gmaking.chat.vo.ConversationSummaryVO">
        INSERT INTO tb_conversation_summary
        (CONVERSATION_ID, ROLLING_SUMMARY, SUMMARY_VERSION, LAST_TURN_ID, LENGTH_CHARS, UPDATED_BY, UPDATED_DATE)
        VALUES
        (#{conversationId},
        #{rollingSummary},
        0,
        #{lastTurnId,jdbcType=INTEGER},
        CHAR_LENGTH(#{rollingSummary}),
        #{updatedBy},
        NOW())
        ON DUPLICATE KEY UPDATE
        ROLLING_SUMMARY = VALUES(ROLLING_SUMMARY),
        SUMMARY_VERSION = COALESCE(SUMMARY_VERSION, 0) + 1,
        LAST_TURN_ID    = VALUES(LAST_TURN_ID),
        LENGTH_CHARS    = CHAR_LENGTH(VALUES(ROLLING_SUMMARY)),
        UPDATED_BY      = VALUES(UPDATED_BY),
        UPDATED_DATE    = NOW()
    </insert>

    <select id="selectByConversationId" parameterType="int" resultMap="ConversationSummaryMap">
        SELECT CONVERSATION_ID, ROLLING_SUMMARY, SUMMARY_VERSION, LAST_TURN_ID,
        LENGTH_CHARS, UPDATED_BY, UPDATED_DATE
        FROM tb_conversation_summary
        WHERE CONVERSATION_ID = #{conversationId}
    </select>

    <update id="updateSummaryByConversationId" parameterType="com.project.gmaking.chat.vo.ConversationSummaryVO">
        UPDATE tb_conversation_summary
        SET ROLLING_SUMMARY = #{rollingSummary},
        SUMMARY_VERSION = COALESCE(SUMMARY_VERSION, 0) + 1,
        LAST_TURN_ID    = #{lastTurnId,jdbcType=INTEGER},
        LENGTH_CHARS    = CHAR_LENGTH(#{rollingSummary}),
        UPDATED_BY      = #{updatedBy},
        UPDATED_DATE    = NOW()
        WHERE CONVERSATION_ID = #{conversationId}
    </update>

    <delete id="deleteByConversationId" parameterType="int">
        DELETE FROM tb_conversation_summary
        WHERE CONVERSATION_ID = #{conversationId}
    </delete>

</mapper>
