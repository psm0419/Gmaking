<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.gmaking.chat.dao.ConversationSummaryDAO">

    <!-- =========================
         ResultMap (새 스키마 기준)
         ========================= -->
    <resultMap id="ConversationSummaryMap" type="com.project.gmaking.chat.vo.ConversationSummaryVO">
        <id     column="CONVERSATION_ID" property="conversationId"/>
        <result column="ROLLING_SUMMARY" property="rollingSummary"/>
        <result column="SUMMARY_VERSION" property="summaryVersion"/>
        <result column="LAST_TURN_ID"    property="lastTurnId"/>
        <result column="LENGTH_CHARS"    property="lengthChars"/>
        <result column="UPDATED_BY"      property="updatedBy"/>
        <result column="UPDATED_DATE"    property="updatedDate"/>
    </resultMap>

    <!-- =========================
         UPSERT: 없으면 INSERT / 있으면 UPDATE
         SUMMARY_VERSION은 +1
         ========================= -->
    <insert id="upsertRollingSummary" parameterType="com.project.gmaking.chat.vo.ConversationSummaryVO">
        INSERT INTO TB_CONVERSATION_SUMMARY
        ( CONVERSATION_ID, ROLLING_SUMMARY, SUMMARY_VERSION, LAST_TURN_ID, LENGTH_CHARS, UPDATED_BY, UPDATED_DATE )
        VALUES
        ( #{conversationId},
        #{rollingSummary},
        COALESCE(#{summaryVersion}, 0) + 1,
        #{lastTurnId},
        CHAR_LENGTH(#{rollingSummary}),
        #{updatedBy},
        NOW()
        )
        ON DUPLICATE KEY UPDATE
        ROLLING_SUMMARY = #{rollingSummary},
        SUMMARY_VERSION = COALESCE(#{summaryVersion}, SUMMARY_VERSION) + 1,
        LAST_TURN_ID    = #{lastTurnId},
        LENGTH_CHARS    = CHAR_LENGTH(#{rollingSummary}),
        UPDATED_BY      = #{updatedBy},
        UPDATED_DATE    = NOW();
    </insert>

    <!-- 단건 조회 (PK) -->
    <select id="selectByConversationId" parameterType="int" resultMap="ConversationSummaryMap">
        SELECT
        CONVERSATION_ID, ROLLING_SUMMARY, SUMMARY_VERSION, LAST_TURN_ID,
        LENGTH_CHARS, UPDATED_BY, UPDATED_DATE
        FROM TB_CONVERSATION_SUMMARY
        WHERE CONVERSATION_ID = #{conversationId}
    </select>

    <!-- 요약만 갱신 (원하면 사용) -->
    <update id="updateSummaryByConversationId" parameterType="com.project.gmaking.chat.vo.ConversationSummaryVO">
        UPDATE TB_CONVERSATION_SUMMARY
        SET
        ROLLING_SUMMARY = #{rollingSummary},
        SUMMARY_VERSION = SUMMARY_VERSION + 1,
        LAST_TURN_ID    = #{lastTurnId},
        LENGTH_CHARS    = CHAR_LENGTH(#{rollingSummary}),
        UPDATED_BY      = #{updatedBy},
        UPDATED_DATE    = NOW()
        WHERE CONVERSATION_ID = #{conversationId}
    </update>

    <!-- 삭제 (PK) -->
    <delete id="deleteByConversationId" parameterType="int">
        DELETE FROM TB_CONVERSATION_SUMMARY
        WHERE CONVERSATION_ID = #{conversationId}
    </delete>

</mapper>
