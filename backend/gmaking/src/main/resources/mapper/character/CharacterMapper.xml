<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.gmaking.character.dao.CharacterDAO">

    <resultMap id="CharacterWithStatMap" type="com.project.gmaking.character.vo.CharacterVO">
        <id property="characterId" column="CHARACTER_ID"/>
        <result property="userId" column="USER_ID"/>
        <result property="characterName" column="CHARACTER_NAME"/>
        <result property="imageId" column="IMAGE_ID"/>
        <result property="characterPersonalityId" column="CHARACTER_PERSONALITY_ID"/>
        <result property="backgroundInfo" column="BACKGROUND_INFO"/>
        <result property="gradeId" column="GRADE_ID"/>
        <result property="totalStageClears" column="TOTAL_STAGE_CLEARS"/>
        <result property="evolutionStep" column="EVOLUTION_STEP"/>

        <association property="characterStat" javaType="com.project.gmaking.character.vo.CharacterStatVO">
            <id property="characterId" column="CHARACTER_ID"/>
            <result property="characterHp" column="CHARACTER_HP"/>
            <result property="characterAttack" column="CHARACTER_ATTACK"/>
            <result property="characterDefense" column="CHARACTER_DEFENSE"/>
            <result property="characterSpeed" column="CHARACTER_SPEED"/>
            <result property="criticalRate" column="CRITICAL_RATE"/>
        </association>
    </resultMap>

<!--   특정 캐릭터 하나 조회-->
    <select id="selectCharacterById" parameterType="int" resultMap="CharacterWithStatMap">
        SELECT
        c.CHARACTER_ID,
        c.USER_ID,
        c.CHARACTER_NAME,
        c.IMAGE_ID,
        i.IMAGE_URL,
        c.CHARACTER_PERSONALITY_ID,
        c.BACKGROUND_INFO,
        c.GRADE_ID,
        c.TOTAL_STAGE_CLEARS,
        c.EVOLUTION_STEP,
        s.CHARACTER_HP,
        s.CHARACTER_ATTACK,
        s.CHARACTER_DEFENSE,
        s.CHARACTER_SPEED,
        s.CRITICAL_RATE
        FROM TB_CHARACTER c
        LEFT JOIN TB_CHARACTER_STAT s ON c.CHARACTER_ID = s.CHARACTER_ID
        LEFT JOIN TB_IMAGE i ON c.IMAGE_ID = i.IMAGE_ID
        WHERE c.CHARACTER_ID = #{characterId}
    </select>

<!--    유저가 가진 캐릭터 전부 조회-->
    <select id="selectCharactersByUser" parameterType="string" resultMap="CharacterWithStatMap">
        SELECT
        c.CHARACTER_ID,
        c.USER_ID,
        c.CHARACTER_NAME,
        c.IMAGE_ID,
        i.IMAGE_URL,
        c.CHARACTER_PERSONALITY_ID,
        c.BACKGROUND_INFO,
        c.GRADE_ID,
        c.TOTAL_STAGE_CLEARS,
        c.EVOLUTION_STEP,
        s.CHARACTER_HP,
        s.CHARACTER_ATTACK,
        s.CHARACTER_DEFENSE,
        s.CHARACTER_SPEED,
        s.CRITICAL_RATE
        FROM TB_CHARACTER c
        LEFT JOIN TB_CHARACTER_STAT s ON c.CHARACTER_ID = s.CHARACTER_ID
        LEFT JOIN TB_IMAGE i ON c.IMAGE_ID = i.IMAGE_ID
        WHERE c.USER_ID = #{userId}
    </select>

    <update id="incrementStageClear">
        UPDATE TB_CHARACTER
        SET TOTAL_STAGE_CLEARS = TOTAL_STAGE_CLEARS + 1,
        UPDATED_DATE = NOW()
        WHERE CHARACTER_ID = #{characterId}
    </update>

</mapper>
