<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.gmaking.quest.dao.QuestDAO">

    <!-- 1. 일일 퀘스트 전체 조회 -->
    <select id="findAllDailyQuests" resultType="com.project.gmaking.quest.vo.QuestVO">
        SELECT * FROM TB_QUEST WHERE QUEST_CYCLE = 'DAILY'
    </select>

    <!-- 2. 유저가 퀘스트 보유 여부 확인 -->
    <select id="findByUserAndQuest" resultType="com.project.gmaking.quest.vo.UserQuestVO">
        SELECT * FROM TB_USER_QUEST
        WHERE USER_ID = #{userId} AND QUEST_ID = #{questId}
    </select>

    <!-- 3. 유저 퀘스트 신규 추가 -->
    <insert id="insertUserQuest" parameterType="com.project.gmaking.quest.vo.UserQuestVO"
            useGeneratedKeys="true" keyProperty="userQuestId">
        INSERT INTO TB_USER_QUEST (USER_ID, QUEST_ID, CURRENT_COUNT, STATUS, STARTED_AT)
        VALUES (#{userId}, #{questId}, #{currentCount}, #{status}, NOW())
    </insert>

    <!-- 4. 퀘스트 타입으로 조회 -->
    <select id="findByType" resultType="com.project.gmaking.quest.vo.QuestVO">
        SELECT * FROM TB_QUEST WHERE QUEST_TYPE = #{questType}
    </select>

    <!-- 5. 진행도 업데이트 -->
    <update id="updateProgress" parameterType="com.project.gmaking.quest.vo.UserQuestVO">
        UPDATE TB_USER_QUEST
        SET CURRENT_COUNT = #{currentCount}, STATUS = #{status}, COMPLETED_AT = #{completedAt}
        WHERE USER_QUEST_ID = #{userQuestId}
    </update>

    <!-- 5-1. 퀘스트 타입 기반 진행도 +1 (JOIN 방식) -->
    <update id="incrementProgressByType">
        UPDATE TB_USER_QUEST uq
        INNER JOIN TB_QUEST q ON uq.QUEST_ID = q.QUEST_ID
        SET uq.CURRENT_COUNT = uq.CURRENT_COUNT + 1,
        uq.STATUS = CASE
        WHEN uq.CURRENT_COUNT + 1 >= q.TARGET_COUNT THEN 'COMPLETED'
        ELSE 'IN_PROGRESS'
        END,
        uq.COMPLETED_AT = CASE
        WHEN uq.CURRENT_COUNT + 1 >= q.TARGET_COUNT THEN CURRENT_TIMESTAMP
        ELSE uq.COMPLETED_AT
        END
        WHERE uq.USER_ID = #{userId}
        AND q.QUEST_TYPE = #{questType}
        AND uq.STATUS = 'IN_PROGRESS';
    </update>


    <!-- 6. 상태 변경 -->
    <update id="updateStatus">
        UPDATE TB_USER_QUEST
        SET STATUS = #{status}, COMPLETED_AT = NOW()
        WHERE USER_ID = #{userId} AND QUEST_ID = #{questId}
    </update>

    <!-- 7. 일일 퀘스트 리셋 -->
    <update id="resetDailyQuests">
        UPDATE TB_USER_QUEST
        SET
        CURRENT_COUNT = 0,
        STATUS = 'IN_PROGRESS',
        STARTED_AT = NOW(),
        COMPLETED_AT = NULL,
        LAST_RESET_DATE = #{today}
        WHERE
        STATUS IN ('COMPLETED', 'REWARDED', 'IN_PROGRESS')
        AND (LAST_RESET_DATE IS NULL OR LAST_RESET_DATE &lt; #{today});
    </update>

    <!-- 8. 유저별 일일 퀘스트 목록 조회 -->
    <select id="findUserDailyQuests" resultType="com.project.gmaking.quest.vo.UserQuestVO">
        SELECT uq.*, q.QUEST_NAME, q.TARGET_COUNT, q.QUEST_TYPE
        FROM TB_USER_QUEST uq
        JOIN TB_QUEST q ON uq.QUEST_ID = q.QUEST_ID
        WHERE uq.USER_ID = #{userId}
        ORDER BY q.QUEST_TYPE
    </select>

</mapper>
